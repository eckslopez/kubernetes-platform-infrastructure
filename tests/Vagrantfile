# On your laptop
mkdir libvirt-script-test
cd libvirt-script-test

# Create Vagrantfile
cat > Vagrantfile <<'EOF'
Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2404"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end
  
  # Install libvirt in the VM
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
    systemctl enable libvirtd
    systemctl start libvirtd
  SHELL
end
EOF

# Spin up VM
vagrant up

# Copy script into VM
vagrant upload ../kubernetes-platform-infrastructure/scripts/configure-libvirt-remote.sh /tmp/

# SSH in and test
vagrant ssh
sudo bash /tmp/configure-libvirt-remote.sh

# Test if it worked
virsh list --all

# Exit and test remote access from host
exit
virsh -c qemu+ssh://vagrant@localhost:2222/system list --all