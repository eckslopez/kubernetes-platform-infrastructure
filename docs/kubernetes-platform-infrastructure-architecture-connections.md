# Architecture & Connections Guide

This document maps out all the network connections and authentication flows in the kubernetes-platform-infrastructure deployment.

## System Architecture Diagram

```
Laptop (Management Station)
    │
    ├─── SSH ────────────────────────> zlab (Hypervisor Host)
    │                                     │
    │                                     ├─ libvirtd
    │                                     ├─ Storage: ~/libvirt_images/
    │                                     └─ Runs 3 VMs:
    │                                         ├─ k3s-cp-01 (control plane)
    │                                         ├─ k3s-worker-01
    │                                         └─ k3s-worker-02
    │
    ├─── SSH ────────────────────────> k3s-cp-01 (for troubleshooting)
    ├─── SSH ────────────────────────> k3s-worker-01 (for troubleshooting)
    ├─── SSH ────────────────────────> k3s-worker-02 (for troubleshooting)
    │
    └─── kubectl (port 6443) ────────> k3s-cp-01 (Kubernetes API)
```

## Connection Details

### 1. Laptop → zlab (SSH)

**Purpose:**
- Terraform connects to libvirt daemon for VM provisioning
- Manual SSH access for hypervisor management
- File transfers (scp/rsync)

**Authentication:** Your existing SSH key (`~/.ssh/id_rsa`)

**User:** `xlopez` (your user on zlab)

**Connection Examples:**
```bash
# Manual SSH
ssh xlopez@zlab

# Terraform libvirt connection
qemu+ssh://xlopez@zlab/system

# Test connection
virsh -c qemu+ssh://xlopez@zlab/system list --all
```

**Ports Used:**
- SSH: 22 (TCP)
- libvirt: Uses SSH tunnel (no additional ports)

---

### 2. Laptop → VMs (SSH)

**Purpose:**
- Troubleshooting (check logs, restart services, debug issues)
- Initial kubeconfig retrieval from control plane
- Manual inspection of cluster state
- **Not for regular cluster management** (use kubectl instead)

**Authentication:** Same SSH key as above (injected by Terraform during VM creation)

**User:** `ubuntu` (default user created by cloud-init in VMs)

**Connection Examples:**
```bash
# SSH to control plane
ssh ubuntu@<k3s-cp-01-ip>

# SSH to worker
ssh ubuntu@<k3s-worker-01-ip>

# Get kubeconfig from control plane
ssh ubuntu@<k3s-cp-01-ip> 'sudo cat /etc/rancher/k3s/k3s.yaml'

# Check k3s service status
ssh ubuntu@<k3s-cp-01-ip> 'sudo systemctl status k3s'
```

**Ports Used:**
- SSH: 22 (TCP)

**IP Discovery:**
After Terraform deployment, get IPs with:
```bash
cd terraform-libvirt
terraform output
```

---

### 3. Laptop → k3s API (kubectl)

**Purpose:**
- Normal Kubernetes operations (deploy apps, check status, scale workloads)
- Primary method for cluster management
- Uses Kubernetes RBAC for authorization

**Authentication:** kubeconfig file containing TLS certificates

**Protocol:** HTTPS over port 6443

**Setup:**
```bash
# Get kubeconfig from control plane
ssh ubuntu@<k3s-cp-01-ip> 'sudo cat /etc/rancher/k3s/k3s.yaml' > ~/.kube/kubernetes-platform-infrastructure.yaml

# Update server IP (change 127.0.0.1 to actual control plane IP)
sed -i 's/127.0.0.1/<k3s-cp-01-ip>/' ~/.kube/kubernetes-platform-infrastructure.yaml

# Use kubectl
kubectl --kubeconfig ~/.kube/kubernetes-platform-infrastructure.yaml get nodes

# Or set as default
export KUBECONFIG=~/.kube/kubernetes-platform-infrastructure.yaml
kubectl get nodes
```

**Ports Used:**
- Kubernetes API: 6443 (TCP)

**Connection Flow:**
```
Laptop → k3s-cp-01:6443 (HTTPS with mTLS)
```

---

### 4. zlab → VMs (libvirt management)

**Purpose:**
- Hypervisor managing virtual machines
- Power on/off, resource allocation
- Virtual console access
- Network bridging

**Authentication:** Local libvirt daemon (runs as root)

**Management:**
```bash
# On zlab
virsh list --all              # List all VMs
virsh start k3s-cp-01         # Start VM
virsh console k3s-cp-01       # Console access
virsh shutdown k3s-cp-01      # Graceful shutdown
```

**Automatic:** libvirt handles this - no manual configuration needed

---

### 5. VMs ↔ VMs (k3s cluster traffic)

**Purpose:**
- k3s control plane ↔ worker node communication
- Pod-to-pod networking (via flannel CNI)
- Service discovery and load balancing
- etcd replication (if using HA control plane)

**Ports Used by k3s:**
- 6443 (TCP): Kubernetes API (control plane)
- 10250 (TCP): kubelet API
- 8472 (UDP): flannel VXLAN overlay
- 2379-2380 (TCP): etcd client/peer (HA only)

**Authentication:**
- Node certificates (auto-generated by k3s)
- Shared cluster token (set by Terraform)

**Automatic:** k3s and flannel handle this

**Network:**
- VMs connected to `host-bridge` (br0)
- Get IPs via DHCP from your router
- All on same LAN segment (can communicate directly)

---

## SSH Key Strategy

### One Key, Multiple Purposes

Your existing SSH keypair (`~/.ssh/id_rsa` / `~/.ssh/id_rsa.pub`) is used for:

1. ✅ **laptop → zlab** (as user `xlopez`)
   - Already configured and working
   - Used for hypervisor management

2. ✅ **laptop → VMs** (as user `ubuntu`)
   - Public key injected by Terraform during VM creation
   - Enables troubleshooting access

3. ✅ **Terraform → zlab libvirt**
   - Terraform uses SSH to connect to libvirt daemon
   - Same key, same user (`xlopez`)

### Configuration

**In terraform.tfvars:**
```hcl
ssh_public_key_path = "~/.ssh/id_rsa.pub"
```

Terraform reads your public key and injects it into VMs via cloud-init.

### No New Keys Required

You don't need to generate new SSH keys. Your existing key works for everything.

---

## Authentication Summary

| Connection | Protocol | Authentication | User |
|------------|----------|----------------|------|
| Laptop → zlab | SSH (port 22) | SSH key | `xlopez` |
| Laptop → VMs | SSH (port 22) | SSH key | `ubuntu` |
| Laptop → k3s API | HTTPS (port 6443) | kubeconfig (mTLS) | N/A |
| Terraform → zlab | SSH tunnel | SSH key | `xlopez` |
| zlab → VMs | libvirt (local) | Local daemon | root |
| VMs ↔ VMs | Various k3s ports | k3s tokens/certs | N/A |

---

## Network Topology

### Physical Network

```
Your Home Network (e.g., 192.168.1.0/24)
    ├─ Router (192.168.1.1) - DHCP server
    ├─ Laptop (192.168.1.x)
    └─ zlab (192.168.1.y) - Bridge network
        └─ br0 (bridged to physical NIC)
            ├─ k3s-cp-01 (192.168.1.z1)
            ├─ k3s-worker-01 (192.168.1.z2)
            └─ k3s-worker-02 (192.168.1.z3)
```

**Bridge Configuration:**
- VMs connected to `host-bridge` libvirt network
- `host-bridge` maps to physical bridge `br0` on zlab
- `br0` is bridged to zlab's physical network interface
- VMs get IPs from your home router via DHCP
- All devices (laptop, zlab, VMs) on same subnet

**Result:** Direct connectivity - laptop can reach VMs without NAT/port forwarding

---

## Common Operations & Their Connections

### Building the Base Image
**Connection:** None (runs locally on zlab)
```bash
# On zlab
cd ~/kubernetes-platform-infrastructure/packer/k3s-node
packer build -var "ubuntu_iso_url=file://$HOME/ubuntu.iso" .
```

### Deploying the Cluster
**Connection:** Laptop → zlab (SSH tunnel for libvirt)
```bash
# From laptop (containerized Terraform)
docker run --rm \
  -v $(PWD)/terraform-libvirt:/workspace \
  -v ~/.ssh:/root/.ssh:ro \
  -e LIBVIRT_DEFAULT_URI=qemu+ssh://xlopez@zlab/system \
  hashicorp/terraform:latest apply
```

### Managing the Cluster
**Connection:** Laptop → k3s API (HTTPS with kubeconfig)
```bash
# From laptop
kubectl get nodes
kubectl apply -f deployment.yaml
kubectl logs pod-name
```

### Troubleshooting VMs
**Connection:** Laptop → VMs (SSH)
```bash
# From laptop
ssh ubuntu@<vm-ip>
sudo journalctl -u k3s -f
sudo systemctl status k3s
```

### Hypervisor Management
**Connection:** Laptop → zlab (SSH) OR local on zlab
```bash
# From laptop
ssh xlopez@zlab 'virsh list --all'

# Or on zlab directly
virsh list --all
virsh console k3s-cp-01
```

---

## Security Considerations

### SSH Key Protection
- Private key (`~/.ssh/id_rsa`) stays on laptop only
- Never copy private key to VMs or zlab
- Public key is safe to distribute (that's the point)

### Kubeconfig Security
- Contains cluster admin credentials
- Store in `~/.kube/` with restricted permissions (0600)
- Don't commit to git repositories
- Can create limited-access kubeconfigs for specific namespaces

### Network Security
- All systems on same LAN (trusted network)
- For external access, use Cloudflare Tunnel (future)
- Consider firewall rules on zlab if needed

### VM Access
- VMs only accept SSH key authentication (no passwords)
- Root login disabled
- Only `ubuntu` user with sudo access

---

## Troubleshooting Connection Issues

### Can't SSH to zlab
```bash
# Test basic connectivity
ping zlab

# Check SSH service
ssh -v xlopez@zlab

# Verify SSH key
ssh-add -l
```

### Can't connect Terraform to libvirt
```bash
# Test libvirt connection manually
virsh -c qemu+ssh://xlopez@zlab/system list --all

# Check if user in libvirt group (on zlab)
ssh xlopez@zlab 'groups'
```

### Can't SSH to VMs
```bash
# Get VM IPs
cd terraform-libvirt && terraform output

# Test connectivity
ping <vm-ip>

# Check SSH key in VM (via console)
virsh console k3s-cp-01
# Login as ubuntu (might need password from cloud-init)
cat ~/.ssh/authorized_keys
```

### Can't connect kubectl to cluster
```bash
# Verify kubeconfig
cat ~/.kube/kubernetes-platform-infrastructure.yaml

# Check server IP is correct (not 127.0.0.1)
grep server: ~/.kube/kubernetes-platform-infrastructure.yaml

# Test API connectivity
curl -k https://<k3s-cp-01-ip>:6443/version

# Check k3s service on control plane
ssh ubuntu@<k3s-cp-01-ip> 'sudo systemctl status k3s'
```

---

## References

- [libvirt Remote Access](https://libvirt.org/remote.html)
- [k3s Networking Requirements](https://docs.k3s.io/installation/requirements#networking)
- [Kubernetes API Access](https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/)
